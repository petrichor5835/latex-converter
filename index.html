<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0ea5e9" />
  <title>LaTeX定界符转换器</title>
  <style>
    :root { --bg:#0b1020; --panel:#111833; --panel-2:#0f1530; --border:#233055; --text:#e6e9f5; --muted:#a8b3cf; --brand:#0ea5e9; --brand-2:#38bdf8; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f24 60%);color:var(--text);font:15px/1.6 ui-sans-serif,-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial}
    a{color:var(--brand-2);text-decoration:none}
    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.1) blur(6px);background:rgba(11,16,32,.7);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .title{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .logo{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;background:radial-gradient(120px 80px at 30% 20%,var(--brand-2),transparent),radial-gradient(120px 80px at 80% 60%,#5eead4,transparent),linear-gradient(180deg,#0b1020,#0b1020);box-shadow:0 0 0 1px rgba(255,255,255,.08) inset,0 8px 30px rgba(0,0,0,.35)}
    .logo span{font-weight:800;color:#03101a;text-shadow:0 1px rgba(255,255,255,.2)}
    h1{font-size:18px;margin:0;letter-spacing:.4px}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:14px;grid-template-columns:1fr;padding:16px 18px 28px}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:0 10px 30px rgba(2,10,40,.35)}
    .card header{position:relative;background:transparent;border-bottom:1px solid var(--border)}
    .card h2{font-size:14px;margin:0;padding:12px 14px;letter-spacing:.3px;color:#d7def6}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;padding:12px;border-bottom:1px solid var(--border)}
    .toolbar .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:#0a1a31;border:1px solid var(--border);border-radius:10px;color:var(--text);cursor:pointer;user-select:none;transition:.2s ease;font-weight:600}
    .btn:hover{background:#0d2040;border-color:#3a4d7a}
    textarea{width:100%;min-height:360px;resize:vertical;outline:none;border:none;background:transparent;color:var(--text);padding:14px;font:14px/1.6 ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .textarea-wrap{position:relative}
    .textarea-wrap::after{content:attr(data-label);position:absolute;top:8px;right:10px;font-size:12px;color:var(--muted)}
    .status{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:4px 8px;border-radius:10px;color:#c3ccef}
    footer{border-top:1px solid var(--border)}
    .foot{font-size:13px;color:var(--muted);padding:16px 18px 40px}
    code{background:#0c1534;border:1px solid var(--border);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div class="logo" aria-hidden="true"><span>TeX</span></div>
        <div>
          <h1>LaTeX 定界符转换器（固定规则·自动复制）</h1>
          <div class="muted">规则固定：行内 \(…\) → $…$；行间 \[…\] / 裸块 [\n…\n] → $$…$$；粘贴即转换；转换后自动复制。</div>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap grid">
    <section class="card" aria-label="输入">
      <header>
        <h2>输入</h2>
        <div class="toolbar">
          <div class="muted">支持裸方括号块：首行仅含 <code>[</code>，末行仅含 <code>]</code>。</div>
          <div class="spacer"></div>
          <button class="btn" id="pasteBtn">粘贴</button>
          <button class="btn" id="clearBtn">清空</button>
        </div>
      </header>
      <div class="textarea-wrap" data-label="Ctrl/Cmd + Enter 转换；粘贴自动转换">
        <textarea id="input" placeholder="在这里粘贴你的 Markdown / LaTeX 文本…"></textarea>
      </div>
      <div class="status" id="inStatus">
        <span class="badge">字符数：<b id="inChars">0</b></span>
        <span class="badge">行数：<b id="inLines">0</b></span>
      </div>
    </section>

    <section class="card" aria-label="输出">
      <header>
        <h2>输出</h2>
        <div class="toolbar">
          <div class="muted">自动：行内→$…$；行间/裸块→$$…$$；转换后自动复制</div>
          <div class="spacer"></div>
          <button class="btn" id="convertBtn">转换</button>
          <button class="btn" id="copyBtn">复制</button>
        </div>
      </header>
      <div class="textarea-wrap" data-label="只读">
        <textarea id="output" readonly placeholder="这里将显示转换后的结果…"></textarea>
      </div>
      <div class="status" id="outStatus">
        <span class="badge">匹配块级 \\[…\\]：<b id="countDisplay">0</b></span>
        <span class="badge">匹配行内 \\(…\\)：<b id="countInline">0</b></span>
        <span class="badge">裸 [ … ] 块：<b id="countPlain">0</b></span>
        <span class="badge">输出字符数：<b id="outChars">0</b></span>
      </div>
    </section>
  </div>

  <footer>
    <div class="wrap foot">
      <p><strong>说明：</strong> 转换顺序为：裸块 → 块级 → 行内 → 括号启发式。括号启发式只在 $/$$ 之外把“像公式”的 <code>(…)</code> 变成 <code>$…$</code>，避免误伤普通括号。</p>
      <p>本工具纯前端、无依赖，直接放到 GitHub Pages 即可。</p>
    </div>
  </footer>

  <script>
  (function(){
    var $ = function(id){ return document.getElementById(id); };
    var els = {
      input: $('input'), output: $('output'),
      inChars: $('inChars'), inLines: $('inLines'), outChars: $('outChars'),
      countDisplay: $('countDisplay'), countInline: $('countInline'), countPlain: $('countPlain'),
      pasteBtn: $('pasteBtn'), clearBtn: $('clearBtn'), convertBtn: $('convertBtn'), copyBtn: $('copyBtn')
    };

    function looksMathy(s){
      return /\\[A-Za-z]+|[=<>_^]|\\(?:frac|dfrac|tfrac|sin|cos|tan|ln|log|cdot|times|sum|int|lim|to|Rightarrow|left|right|boxed)/.test(s);
    }

    function convertTopLevelParens(seg){
      var res = '', last = 0, depth = 0, start = -1, i;
      for (i=0;i<seg.length;i++){
        var ch = seg[i];
        if (ch === '('){ if (depth === 0) start = i; depth++; }
        else if (ch === ')'){
          if (depth > 0){ depth--; if (depth === 0 && start >= 0){
            var before = seg.slice(last, start);
            var inner  = seg.slice(start+1, i);
            res += before + (looksMathy(inner) ? ('$'+inner+'$') : ('('+inner+')'));
            last = i + 1; start = -1;
          }}
        }
      }
      res += seg.slice(last);
      return res;
    }

    function replaceParenOutsideMath(text){
      var out = '', i = 0, n = text.length;
      while (i < n){
        if (text.slice(i, i+2) === '$$'){
          var j1 = text.indexOf('$$', i+2);
          if (j1 === -1){ out += text.slice(i); break; }
          out += text.slice(i, j1+2); i = j1+2; continue;
        }
        if (text[i] === '$'){
          var j2 = text.indexOf('$', i+1);
          if (j2 === -1){ out += text.slice(i); break; }
          out += text.slice(i, j2+1); i = j2+1; continue;
        }
        var next = text.indexOf('$', i); if (next === -1) next = n;
        out += convertTopLevelParens(text.slice(i, next));
        i = next;
      }
      return out;
    }

    function removeCommasBeforeDifferentials(text){
      // Remove commas before differential operators like dx, dy, dt, dz, du, dv, dw, ds, dr, dtheta, etc.
      // This pattern matches: comma + optional whitespace + 'd' + one or more letters
      return text.replace(/,(\s*d[a-z]+)/gi, function(_, differential){ return ' ' + differential; });
    }

    function convertText(src){
      var out = src; var cDisp = 0, cIn = 0, cPlain = 0;
      // 裸块：[\n ... \n] 独占一行 → $$…$$
      out = out.replace(/^\[\s*\r?\n([\s\S]*?)^\]\s*$/gm, function(_, inner){ cPlain++; return '$$'+inner+'$$'; });
      // 标准块：\[ … \] → $$…$$
      out = out.replace(/\\\[((?:.|\r?\n)*?)\\\]/g, function(_, inner){ cDisp++; return '$$'+inner+'$$'; });
      // 行内：\( … \) → $…$
      out = out.replace(/\\\(((?:.|\r?\n)*?)\\\)/g, function(_, inner){ cIn++; return '$'+inner+'$'; });
      // 在 $/$$ 外把“像公式”的 (… ) 变为 $…$
      out = replaceParenOutsideMath(out);
      // 移除积分中的逗号（如 ,dx → dx）
      out = removeCommasBeforeDifferentials(out);

      if (els.countDisplay) els.countDisplay.textContent = String(cDisp);
      if (els.countInline)  els.countInline.textContent  = String(cIn);
      if (els.countPlain)   els.countPlain.textContent   = String(cPlain);
      return out;
    }

    function refresh(){
      var src = els.input.value;
      var out = convertText(src);
      els.output.value = out;
      if (els.inChars)  els.inChars.textContent = String(src.length);
      if (els.inLines)  els.inLines.textContent = String(src.split(/\r?\n/).length);
      if (els.outChars) els.outChars.textContent = String(out.length);
    }

    function toast(msg, warn){
      var t = document.createElement('div'); t.textContent = msg;
      t.style.position = 'fixed'; t.style.left = '50%'; t.style.top = '18px'; t.style.transform = 'translateX(-50%)';
      t.style.background = warn ? '#3d2a07' : '#04283a'; t.style.color = warn ? '#ffd8a8' : '#bfe9ff';
      t.style.border = '1px solid #233055'; t.style.padding = '8px 12px'; t.style.borderRadius = '10px'; t.style.zIndex = '50';
      t.style.boxShadow = '0 10px 30px rgba(0,0,0,.4)'; t.style.fontWeight = '600';
      document.body.appendChild(t); setTimeout(function(){ t.remove(); }, 1800);
    }

    // 交互：转换按钮 → 转换并复制
    if (els.convertBtn) els.convertBtn.addEventListener('click', function(){
      refresh();
      try { navigator.clipboard.writeText(els.output.value).then(function(){ toast('已转换并复制到剪贴板'); }); }
      catch (e) { toast('已转换，但复制失败：浏览器未授权', true); }
    });

    // 复制按钮
    if (els.copyBtn) els.copyBtn.addEventListener('click', function(){
      try { navigator.clipboard.writeText(els.output.value).then(function(){ toast('已复制到剪贴板'); }); }
      catch (e) { toast('复制失败：浏览器未授权', true); }
    });

    // 粘贴按钮：读取→转换→复制
    if (els.pasteBtn) els.pasteBtn.addEventListener('click', function(){
      if (!navigator.clipboard || !navigator.clipboard.readText){ toast('浏览器未授权读取剪贴板，直接在左侧 Ctrl/Cmd+V 也会自动转换', true); return; }
      navigator.clipboard.readText().then(function(txt){
        els.input.value = txt; refresh();
        try { navigator.clipboard.writeText(els.output.value).then(function(){ toast('已粘贴并复制转换结果'); }); } catch (e) {}
      }).catch(function(){ toast('无法读取剪贴板内容', true); });
    });

    // 输入框：粘贴后自动转换并尝试复制结果
    if (els.input) els.input.addEventListener('paste', function(){
      setTimeout(function(){
        refresh();
        try { navigator.clipboard.writeText(els.output.value); } catch (e) {}
      }, 0);
    });

    // 清空
    if (els.clearBtn) els.clearBtn.addEventListener('click', function(){ els.input.value = ''; refresh(); });

    // 快捷键：Ctrl/Cmd + Enter 转换
    document.addEventListener('keydown', function(e){ if ((e.ctrlKey || e.metaKey) && (e.key || '').toLowerCase() === 'enter'){ e.preventDefault(); if (els.convertBtn) els.convertBtn.click(); }});

    // 首次渲染
    refresh();
  })();
  </script>
</body>
</html>
